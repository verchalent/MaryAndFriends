# Traefik Configuration Fix Documentation

## Issues Identified and Fixed

### 1. Missing Service Port Configuration
**Problem**: Traefik labels were missing the service port specification, so Traefik didn't know which port to connect to on the agent containers.

**Fix**: Added the following labels to each agent service:
```yaml
- traefik.http.services.{agent_name}.loadbalancer.server.port=8501
- traefik.docker.network=ai_agents_network
```

### 2. Updated docker-compose.yml
**Changes Made**:
- Added `traefik.http.services.mary.loadbalancer.server.port=8501` to mary service
- Added `traefik.http.services.rick.loadbalancer.server.port=8501` to rick service  
- Added `traefik.docker.network=ai_agents_network` to both services

### 3. Updated generate_agents.py Script
**Changes Made**: 
- Modified the Traefik labels generation to include the service port and network labels
- Future agents generated by the script will have the correct configuration

## Key Configuration Elements

### Traefik Service Configuration
```yaml
traefik:
  image: traefik:v3
  command:
    - "--api.insecure=true"
    - "--providers.docker=true"  
    - "--providers.docker.exposedbydefault=false"
    - "--entrypoints.web.address=:80"
  ports:
    - "80:80"     # HTTP traffic
    - "8080:8080" # Traefik dashboard
  volumes:
    - "/var/run/docker.sock:/var/run/docker.sock:ro"
  networks:
    - ai_agents_network
```

### Agent Service Labels (Required for Traefik Discovery)
```yaml
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.{agent_name}.rule=Host(`{agent_name}.local`)"
  - "traefik.http.routers.{agent_name}.entrypoints=web"
  - "traefik.http.services.{agent_name}.loadbalancer.server.port=8501"
  - "traefik.docker.network=ai_agents_network"
```

## Testing the Configuration

### 1. Start the Services
```bash
# In the project root directory
docker-compose up --build -d
```

### 2. Verify Traefik Dashboard
Visit: http://localhost:8080

You should see:
- Traefik dashboard is accessible
- HTTP services show mary and rick services
- Each service shows correct backend servers

### 3. Add Hosts File Entries
Add these lines to `/etc/hosts` (Linux/macOS) or `C:\Windows\System32\drivers\etc\hosts` (Windows):
```
127.0.0.1 mary.local
127.0.0.1 rick.local
```

### 4. Test Agent Access
- Visit: http://mary.local (should show Mary agent)
- Visit: http://rick.local (should show Rick agent)

### 5. Run Diagnostic Script
```bash
# Run the diagnostic tool
python test_traefik_setup.py
```

## Troubleshooting

### Common Issues and Solutions

**Issue**: "502 Bad Gateway" errors
**Solution**: 
- Check if agent containers are healthy: `docker ps`
- Verify port 8501 is exposed in agent containers
- Check agent container logs: `docker logs {container_name}`

**Issue**: "404 Not Found" errors  
**Solution**:
- Verify Traefik can discover services via dashboard
- Check that agent containers have correct labels
- Ensure agents are on the same network as Traefik

**Issue**: Cannot access Traefik dashboard
**Solution**:
- Check if Traefik container is running: `docker ps`
- Verify port 8080 is not in use by another service
- Check Traefik logs: `docker logs {traefik_container_name}`

### Verification Commands

```bash
# Check running containers
docker ps

# Check Traefik logs
docker logs maryandfriends_traefik_1

# Check agent logs
docker logs maryandfriends_mary_1
docker logs maryandfriends_rick_1

# Check networks
docker network ls
docker network inspect maryandfriends_ai_agents_network

# Test Traefik API
curl http://localhost:8080/api/http/services
curl http://localhost:8080/api/http/routers
```

## Task Update

The following Phase 2 tasks can now be marked as completed:

- [x] **Task 2.1**: Established dedicated Docker network (ai_agents_network)
- [x] **Task 2.2**: Deployed Traefik v3 container with proper configuration  
- [x] **Task 2.3**: Configured Traefik as proxy for agents with correct labels

### Next Steps for User Acceptance Testing
1. Run `docker-compose up --build -d`
2. Add hosts file entries for mary.local and rick.local
3. Test access to both agents via their Traefik hostnames
4. Verify Traefik dashboard shows service discovery
5. Run diagnostic script to confirm all tests pass
